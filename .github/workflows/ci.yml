name: AutoSec CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  security-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ✅ 1) Unit Tests
      - name: Run tests
        run: |
          pytest -q

      # ✅ 4) Workflow risk analysis (Day 3)
      - name: Run Workflow Risk Analyzer
        run: |
          python src/workflow_analyzer.py


      # ✅ 2) Secret scanning with Gitleaks (DevSecOps standard)
      - name: Run Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --report-format json --report-path reports/gitleaks-report.json
        continue-on-error: true

      # ✅ 3) Dependency vulnerability scan (pip-audit)
      - name: Run pip-audit dependency scan
        run: |
          pip-audit -r requirements.txt -f json -o reports/pip-audit-report.json
        continue-on-error: true

      # ✅ 4) Upload reports as GitHub artifacts
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
